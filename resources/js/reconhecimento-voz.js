const educacaoAmbiental = {
    "palavras" : ["educação ambiental", "sustentabilidade", "reciclagem", "conservação", "ecossistema", "biodiversidade", "poluição", "desenvolvimento sustentável", "energia renovável", "preservação", "ecologia", "redução de resíduos"],
    "audio" : "../../assets/audios/educacao-ambiental.mp3",
    "pagina" : "../html/educacao-ambiental.html",
    "mapa" : false
}

const sucessaoEcologica = {
    "palavras" : ["sucessão ecológica", "ecese", "organismos pioneiros"],
    "audio" : "../../assets/audios/sucessao-ecologica.mp3",
    "pagina" : "../html/sucessao-ecologica.html",
    "mapa" : false
}

const incendio = {
    "palavras" : ["incêndio", "fogo", "queimada", "queimadas", "chamas", "incêndio florestal", "ignição", "devastação", "fogaréu"],
    "audio" : "../../assets/audios/incendio.mp3",
    "pagina" : "../html/incendio-criminoso.html",
    "mapa" : false
}

const atividadeHumana = {
    "palavras" : ["atividade humana", "intervenção humana", "ações humanas", "humana", "humanos"],
    "audio" : "../../assets/audios/atividades-humanas.mp3",
    "pagina" : "../html/atividades-humanas.html",
    "mapa" : false
}

const qualidadeAgua = {
    "palavras" : ["qualidade da água", "água", "água potável", "beber água", "consumir água"],
    "audio" : "../../assets/audios/qualidade-agua.mp3",
    "pagina" : "../html/classificacao-agua.html",
    "mapa" : false
}

const classificacaoArborea = {
    "palavras" : ["classificação arbórea", "classificação árvores", "arbórea", "pioneiras", "secundárias", "clímax"],
    "audio" : "../../assets/audios/classificacao-arborea.mp3",
    "pagina" : "../html/especies-arboreas.html",
    "mapa" : false
}

const especieFlora = {
    "palavras" : ["espécies de flora", "espécies de Flora", "tipos de plantas", "flora", "espécies de planta", "árvores", "árvore"],
    "audio" : "../../assets/audios/especies-flora.mp3",
    "pagina" : "../html/especies-flora.html",
    "mapa" : false
}

const classificacaoGeologica = {
    "palavras" : ["classificação geológica", "classificação solo", "análise do solo", "análise solo", "geologia", "topografia", "solo"],
    "audio" : "../../assets/audios/classificacao-geologica.mp3",
    "pagina" : "../html/classificacao-geologica.html",
    "mapa" : false
}

const especieFauna = {
    "palavras" : ["espécies de fauna", "fauna", "animais", "aves", "mamíferos", "répteis", "anfíbios", "passarinho", "passarinhos", "capivara", "tipo de animais", "tipos de animais", "sapo", "cobra", "tipo de animal", "animal"],
    "audio" : "../../assets/audios/especies-fauna.mp3",
    "pagina" : "../html/especies-fauna.html",
    "mapa" : false
}

const bioma = {
    "palavras" : ["bioma", "vegetação", "fragmento florestal"],
    "audio" : "../../assets/audios/bioma.mp3",
    "pagina" : "../html/bioma-mata-atlantica.html",
    "mapa" : false
}

const clima = {
    "palavras" : ["clima", "úmido"],
    "audio" : "../../assets/audios/clima.mp3",
    "pagina" : "../html/clima-cidade.html",
    "mapa" : false
}

const contextoHistorico = {
    "palavras" : ["contexto histórico", "história", "estação sericícola", "seda", "bituca"],
    "audio" : "../../assets/audios/contexto-historico.mp3",
    "pagina" : "../html/contextualizacao-historica.html",
    "mapa" : false
}

const lagoaQuatro = {
    "palavras" : ["lagoa 4", "Lagoa 4", "local mais próximo", "lugar mais próximo", "local mais perto", "lugar mais perto"],
    "audio" : "../../assets/audios/lagoa4.mp3",
    "pagina" : "../html/mapa.html",
    "mapa" : true
}

const construcaoHistorica = {
    "palavras" : ["construção histórica", "construção"],
    "audio" : "../../assets/audios/construcao-historica.mp3",
    "pagina" : "../html/mapa.html",
    "mapa" : true
}

const lagoaTres = {
    "palavras" : ["lagoa 3", "Lagoa 3"],
    "audio" : "../../assets/audios/lagoa3.mp3",
    "pagina" : "../html/mapa.html",
    "mapa" : true
}

const reflorestamento = {
    "palavras" : ["reflorestamento", "Reflorestamento"],
    "audio" : "../../assets/audios/areas-reflorestamento.mp3",
    "pagina" : "../html/mapa.html",
    "mapa" : true
}

const ruinas = {
    "palavras" : ["ruínas", "Ruínas"],
    "audio" : "../../assets/audios/ruinas.mp3",
    "pagina" : "../html/mapa.html",
    "mapa" : true
}

const fragmentoMata = {
    "palavras" : ["fragmento", "mata atlântica"],
    "audio" : "../../assets/audios/fragmento-mata-atlantica.mp3",
    "pagina" : "../html/mapa.html",
    "mapa" : true
}

const lagoaUm = {
    "palavras" : ["lagoa 1", "Lagoa 1"],
    "audio" : "../../assets/audios/lagoa1.mp3",
    "pagina" : "../html/mapa.html",
    "mapa" : true

}

const CONTEUDOS = [
    lagoaUm,
    fragmentoMata,
    ruinas,
    reflorestamento,
    lagoaTres,
    construcaoHistorica,
    lagoaQuatro,
    contextoHistorico,
    clima,
    bioma,
    especieFauna,
    classificacaoGeologica,
    especieFlora,
    classificacaoArborea,
    qualidadeAgua,
    atividadeHumana,
    incendio,
    sucessaoEcologica,
    educacaoAmbiental
]

const PLANTAS = {
    "camboatá" : "../html/template.html?local=camboata",
    "abacateiro" : "../html/template.html?local=abacateiro",
    "lavanda" : "../html/template.html?local=lavanda",
    "quaresmeira" : "../html/template.html?local=quaresmeira",
    "sangra d'água" : "../html/template.html?local=sangra-dagua",
    "sangra" : "../html/template.html?local=sangra-dagua",
    "d'água" : "../html/template.html?local=sangra-dagua",
    "bordo da noruega" : "../html/template.html?local=bordo-da-noruega",
    "bordo" : "../html/template.html?local=bordo-da-noruega",
    "noruega" : "../html/template.html?local=bordo-da-noruega",
    "aroeira vermelha" : "../html/template.html?local=aroeira-vermelha",
    "aroeira" : "../html/template.html?local=aroeira-vermelha",
    "vermelha" : "../html/template.html?local=aroeira-vermelha",
    "ipê tabaco" : "../html/template.html?local=ipe-tabaco",
    "ipê" : "../html/template.html?local=ipe-tabaco",
    "tabaco" : "../html/template.html?local=ipe-tabaco",
    "vassourão" : "../html/template.html?local=vassourao",
    "cafezinho do mato" : "../html/template.html?local=cafezinho-do-mato",
    "cafezinho" : "../html/template.html?local=cafezinho-do-mato",
    "cafézinho" : "../html/template.html?local=cafezinho-do-mato",
    "jacarandá paulista" : "../html/template.html?local=jacaranda-paulista",
    "jacarandá" : "../html/template.html?local=jacaranda-paulista",
    "jacaranda paulista" : "../html/template.html?local=jacaranda-paulista",
    "jacaranda" : "../html/template.html?local=jacaranda-paulista",
}

const botaoFalar = document.getElementById("btn-reconhecer-voz")
const botaoConfirmouFala = document.getElementById("botaoConfirmouTexto")
const textoConfirmacaoFala = document.getElementById("confirmacaoTexto")
const modalConfirmacao = new bootstrap.Modal(document.getElementById("modalConfirmacao"))
const audioRespostaPadrao = "../../assets/audios/resposta-padrao.mp3"
const audioPlantas = "../../assets/audios/audio-plantas.mp3"

//Verifica qual biblioteca está sendo utilizada pelo navagedor
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

let reconhecimentoVoz = new SpeechRecognition()

//Define se a gravação é continua ou não
reconhecimentoVoz.continuos = true

//Especifica a linguagem a ser usada
reconhecimentoVoz.lang = 'pt-BR'

botaoFalar.addEventListener("click", () => {
    try {
        reconhecimentoVoz.start()
    } catch (erro) {
        reconhecimentoVoz.stop()
    }
}, false)

botaoConfirmouFala.addEventListener('click', async () => {
    modalConfirmacao.hide()

    var textoFaladoUsuario = textoConfirmacaoFala.innerHTML
    let nomeArquivoAudioSerTocado = audioRespostaPadrao
    let localRedirecionamento = ""
    let redirecionarMapa = false
    let plantaFalada = verificarFalouPlanta(textoFaladoUsuario)

    if (plantaFalada){
        nomeArquivoAudioSerTocado = audioPlantas
        localRedirecionamento = PLANTAS[plantaFalada]
        redirecionarMapa = false
    } else {
        for(const conteudo of CONTEUDOS){
            if(verificarPossuiPalavra(textoFaladoUsuario, conteudo['palavras'])){
                nomeArquivoAudioSerTocado = conteudo['audio']
                localRedirecionamento = conteudo['pagina']
                redirecionarMapa = conteudo['mapa']
            }
        }
    }

    if(redirecionarMapa){
        window.location.href = `${localRedirecionamento}?audio=${nomeArquivoAudioSerTocado}`
    } else if(localRedirecionamento){
        await tocarArquivoAudio(new Audio(nomeArquivoAudioSerTocado))
        window.location.href = localRedirecionamento
    } else{
        tocarArquivoAudio(new Audio(nomeArquivoAudioSerTocado))
    }
})


reconhecimentoVoz.addEventListener('result', function (evt) {
    var textoFaladoUsuario = evt.results[0][0].transcript
    textoConfirmacaoFala.innerHTML = textoFaladoUsuario
    modalConfirmacao.show()
})

reconhecimentoVoz.addEventListener('audiostart', function (){
    const textoGravando = document.getElementById("gravando-pergunta-voz")
    if(textoGravando.classList.contains("invisible")){
        textoGravando.classList.remove("invisible")
    }
})

reconhecimentoVoz.addEventListener('audioend', function (){
    const textoGravando = document.getElementById("gravando-pergunta-voz")
    if(!textoGravando.classList.contains("invisible")){
        textoGravando.classList.add("invisible")
    }
})

function tocarArquivoAudio(arquivoAudio) {
    return new Promise(resposta =>{
        arquivoAudio.play()
        arquivoAudio.onended = resposta
    })
}

function verificarPossuiPalavra(textoFalado, listaPalavras){
    return listaPalavras.some(palavra => textoFalado.includes(palavra))
}

function verificarFalouPlanta(textoFalado){
    palavras = textoFalado.split(' ')
    for (palavra of palavras){
        palavaraMinusculo = palavra.toLowerCase()
        if (palavaraMinusculo in PLANTAS){
            return palavaraMinusculo
        }
    }
    return null
}